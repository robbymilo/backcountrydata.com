---
kind: pipeline
type: docker
name: api

platform:
  os: linux
  arch: amd64

steps:
  - name: build_push_image
    image: plugins/docker
    settings:
      username:
        from_secret: docker_username
      password:
        from_secret: docker_password
      repo: robbymilo/backcountrydata
      dockerfile: api/Dockerfile
      tags:
        - ${DRONE_COMMIT_SHA:0:7}
        - latest

trigger:
  event:
  - push
  branch:
  - master
  paths:
    include:
      - api/**

---
kind: pipeline
type: docker
name: frontend

platform:
  os: linux
  arch: amd64

steps:
  - name: build-container
    image: docker
    volumes:
    - name: dockersock
      path: /var/run/docker.sock
    commands:
    - docker build . -t backcountrydata-frontend:latest

  - name: build_frontend
    image: backcountrydata-frontend:latest
    pull: if-not-exists
    environment:
      TOKEN:
        from_secret: netlify_auth_token
    commands:
      - make build-frontend

  - name: deploy_production_frontend
    image: backcountrydata-frontend:latest
    pull: if-not-exists
    when:
      branch:
        include:
          - master
    environment:
      TOKEN:
        from_secret: netlify_auth_token
    commands:
      - netlify deploy --dir frontend/dist --site c227ef54-b0f6-434b-9c19-7db3ff8e416c --auth $TOKEN --prod

  - name: deploy_staging_frontend
    image: backcountrydata-frontend:latest
    pull: if-not-exists
    when:
      branch:
        exclude:
          - master
    environment:
      TOKEN:
        from_secret: netlify_auth_token
    commands:
      - netlify deploy --dir frontend/dist --site c227ef54-b0f6-434b-9c19-7db3ff8e416c --auth $TOKEN --alias ${DRONE_BRANCH}

trigger:
  event:
  - push
  paths:
    include:
      - frontend/**

volumes:
- name: dockersock
  host:
    path: /var/run/docker.sock